/* Gsloader - v0.0.2rc - 2013-02-20
* https://github.com/vkadam/gsloader
* Copyright (c) 2013 Vishal Kadam; Licensed MIT */
(function(e,t){"use strict";function r(e,t){var r;return"string"==typeof e&&(r={},r[t]=e),r||e}String.prototype.format||(String.prototype.format=function(){for(var e=""+this,t=0;arguments.length>t;t++){var r=RegExp("\\{"+t+"\\}","gm");e=e.replace(r,arguments[t])}return e}),String.prototype.encodeXML||(String.prototype.encodeXML=function(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/\n/g,"&#10;")});var n=function(e){t.extend(this,{debug:!1},e)};n.prototype={log:function(){this.debug&&"undefined"!=typeof console&&console.log!==void 0&&console.log.apply(console,arguments)}};var i=function(e){n.call(this,e)};i.prototype=new n;var o=new i;i.prototype.loadSpreadsheet=function(e){var n={},i=t.Deferred();e=t.extend({context:n},r(e,"id"));var o=new a({id:e.id,wanted:e.wanted});return i.promise(n),o.fetch().done(function(){i.resolveWith(e.context,[o])}),n},i.prototype.enableLog=function(){return this.debug=!0,this},i.prototype.disableLog=function(){return this.debug=!1,this},i.prototype.createSpreadsheet=function(e){function n(e){var t=new a({id:e.id,title:e.title});t.fetch().done(function(){s.resolveWith(o.context,[t])})}var i={},o=t.extend({title:"",context:i},r(e,"title")),s=t.Deferred();return this.drive.createSpreadsheet({title:o.title}).done(n),s.promise(i),i};var a=function(e){e=r(e,"id"),e&&/id=/.test(e.id)&&(o.log("You passed a id as a URL! Attempting to parse."),e.id=e.id.match("id=([^&]*)")[1]),t.extend(this,{id:"",title:""},e,{sheetsToLoad:[],worksheets:[]})};a.PRIVATE_SHEET_URL="https://spreadsheets.google.com/feeds/worksheets/{0}/private/full",a.WORKSHEET_ID_REGEX=/.{3}$/,a.WORKSHEET_CREATE_REQ='<entry xmlns="http://www.w3.org/2005/Atom" xmlns:gs="http://schemas.google.com/spreadsheets/2006"><title>{0}</title><gs:rowCount>{1}</gs:rowCount><gs:colCount>{2}</gs:colCount></entry>',a.prototype={fetch:function(){var e=this,r=t.Deferred(),n={};return r.promise(n),t.ajax({url:a.PRIVATE_SHEET_URL.format(this.id)}).done(function(i,o,a){e.parse(i,o,a);var s=e.fetchSheets();s.length>0?t.when.apply(t,s).done(function(){r.resolveWith(n,[e])}):r.resolveWith(n,[e])}),n},isWanted:function(e){return"*"===this.wanted||this.wanted instanceof Array&&-1!==this.wanted.indexOf(e)},parse:function(e){var r=this,n=t(e).children("feed");r.title=n.children("title").text();var i;r.worksheets=[],n.children("entry").each(function(){i=r.parseWorksheet(this),r.worksheets.push(i),r.isWanted(i.title)&&r.sheetsToLoad.push(i)})},parseWorksheet:function(e){var r=t(e),n=r.children("title").text(),i=new s({id:r.children("id").text().match(a.WORKSHEET_ID_REGEX)[0],title:n,listFeed:r.children("link[rel*='#listfeed']").attr("href"),cellsFeed:r.children("link[rel*='#cellsfeed']").attr("href"),editLink:r.children("link[rel='edit']").attr("href"),metadata:r,spreadsheet:this});return i},fetchSheets:function(){var e=[];return t.each(this.sheetsToLoad,function(t,r){e.push(r.fetch())}),e},createWorksheet:function(e){var n=this,i=t.Deferred(),s={};i.promise(s),e=t.extend({title:"",rows:20,cols:20,context:s,headers:[],rowData:[]},r(e,"title")),o.log("Creating worksheet for spreadsheet",this,"with options =",e);var h;return t.ajax({url:a.PRIVATE_SHEET_URL.format(this.id),type:"POST",contentType:"application/atom+xml",headers:{"GData-Version":"3.0"},data:a.WORKSHEET_CREATE_REQ.format(e.title,e.rows,e.cols)}).done(function(r,a,s){var d=t(s.responseText).filter(function(){return"ENTRY"===this.nodeName});if(h=n.parseWorksheet(d),n.worksheets.push(h),h.listFeed=h.cellsFeed.replace("/cells/","/list/"),e.headers.length>0||e.rowData.length>0){var l=e.rowData;l.unshift(e.headers),h.addRows(l).done(function(){o.log("Rows added to worksheet.",h,"Fetching latest data for worksheet"),h.fetch().done(function(){i.resolveWith(e.context,[h])})})}else i.resolveWith(e.context,[h])}),s}};var s=function(e){t.extend(this,{id:"",title:"",listFeed:"",cellsFeed:"",editLink:"",metadata:null,rows:[],spreadsheet:null},e)};s.COLUMN_NAME_REGEX=/gsx:/,s.CELL_FEED_HEADER='<feed xmlns="http://www.w3.org/2005/Atom" xmlns:batch="http://schemas.google.com/gdata/batch" xmlns:gs="http://schemas.google.com/spreadsheets/2006"><id>{0}</id>{1}</feed>',s.CELL_FEED_ENTRY='<entry><batch:id>R{1}C{2}</batch:id><batch:operation type="update"/><id>{0}/R{1}C{2}</id><gs:cell row="{1}" col="{2}" inputValue="{3}"/></entry>',s.prototype={fetch:function(){var e=this,r=t.Deferred(),n={};return r.promise(n),t.ajax({url:this.listFeed}).done(function(){e.parse.apply(e,arguments),r.resolveWith(n,[e])}),n},parse:function(e){var r=this,n=t(e).children("feed").children("entry");if(0===n.length)return o.log("Missing data for "+r.title+", make sure you didn't forget column headers"),r.rows=[],void 0;r.rows=[];var i;n.each(function(e){i={rowNumber:e+1},t(this).children().each(function(){s.COLUMN_NAME_REGEX.test(this.tagName)&&(i[this.tagName.replace(s.COLUMN_NAME_REGEX,"")]=this.textContent)}),r.rows.push(i)}),o.log("Total rows in worksheet '"+this.title+"' = "+r.rows.length)},addRows:function(e){var r,n,i,o=this,a=[],h=t.Deferred(),d={};h.promise(d),t.each(e,function(e,h){r=e+1,t.each(h,function(e,t){n=e+1,null!==t&&t!==void 0&&(i="string"==typeof t?t.encodeXML():t,a.push(s.CELL_FEED_ENTRY.format(o.cellsFeed,r,n,i)))})});var l=s.CELL_FEED_HEADER.format(o.cellsFeed,a.join(""));return t.ajax({url:this.cellsFeed+"/batch",type:"POST",contentType:"application/atom+xml",headers:{"GData-Version":"3.0","If-Match":"*"},data:l}).done(function(e,t,r){h.resolveWith(d,[e,t,r])}),d},rename:function(e){var r=this,n=t.Deferred(),i={};return n.promise(i),t.ajax({url:a.PRIVATE_SHEET_URL.format(this.spreadsheet.id)}).done(function(s){var h=t(s).children("feed");h.children("entry").filter(function(){var e=t(this).children("id").text().match(a.WORKSHEET_ID_REGEX)[0];return e===r.id}).each(function(){var e=r.spreadsheet.parseWorksheet(this);r.metadata=e.metadata}),o.log("Renaming worksheet with title =",e);var d=r.metadata.clone();d.children("title").text(e);var l=(new XMLSerializer).serializeToString(d[0]);t.ajax({url:r.editLink,type:"PUT",contentType:"application/atom+xml",data:l}).done(function(e){var a=r.spreadsheet.parseWorksheet(t(e).children("entry"));r.metadata=a.metadata,r.title=a.title,r.listFeed=a.listFeed,r.cellsFeed=a.cellsFeed,r.editLink=a.editLink,o.log("Worksheet renamed successfully with title =",r.title),n.resolveWith(i,[r])})}),i}},t.extend(e,{GSLoader:o})})(window,jQuery),function(e,t){"use strict";var r=function(){};r.prototype={load:function(){return gapi.client.load("drive","v2",this.onLoad),this},onLoad:function(){return e.auth.checkAuth(),this},createSpreadsheet:function(e){var r={},n=t.extend({title:"",context:r},e),i=t.Deferred(),o=gapi.client.request({path:"/drive/v2/files",method:"POST",body:{title:n.title,mimeType:"application/vnd.google-apps.spreadsheet"}});return i.promise(r),o.execute(function(e){i.resolveWith(n.context,[e])}),r}},t.extend(e,{drive:new r})}(GSLoader,jQuery),function(e,t){"use strict";var r=function(){this.CLIENT_ID=null,this.SCOPES=["https://www.googleapis.com/auth/drive","https://spreadsheets.google.com/feeds"].join(" ")};r.prototype={setClientId:function(e){return this.CLIENT_ID=e,this},onLoad:function(e,t){return this.checkAuth(),e&&e.apply(t,this),this},checkAuth:function(){return gapi.auth.authorize({client_id:this.CLIENT_ID,scope:this.SCOPES,immediate:!0},this.handleAuthResult),this},handleAuthResult:function(t){var n=this;return n instanceof r||(n=e.auth),t&&!t.error?e.log("Google Api Authentication Succeed"):(e.log("Authenticating Google Api"),gapi.auth.authorize({client_id:n.CLIENT_ID,scope:n.SCOPES,immediate:!1},n.handleAuthResult)),n}},t.extend(e,{auth:new r})}(GSLoader,jQuery);