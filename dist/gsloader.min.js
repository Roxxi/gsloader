/* Gsloader - v0.0.1-rc.2
* https://github.com/vkadam/gsloader
* Copyright (c) Vishal Kadam; Licensed MIT */
define("js/utils",[],function(){return{sanitizeOptions:function(a,b){var c;return"string"==typeof a&&(c={},c[b]=a),c||a},PRIVATE_SHEET_URL:"https://spreadsheets.google.com/feeds/worksheets/{0}/private/full",WORKSHEET_ID_REGEX:/.{3}$/}}),define("js/worksheet",["jquery","logger","js/utils"],function(a,b,c){var d=function(c){this.logger=b.get("Worksheet"),a.extend(this,{id:"",title:"",listFeed:"",cellsFeed:"",editLink:"",metadata:null,rows:[],spreadsheet:null},c)},e=/gsx:/,f='<feed xmlns="http://www.w3.org/2005/Atom" xmlns:batch="http://schemas.google.com/gdata/batch" xmlns:gs="http://schemas.google.com/spreadsheets/2006"><id>{0}</id>{1}</feed>',g='<entry><batch:id>R{1}C{2}</batch:id><batch:operation type="update"/><id>{0}/R{1}C{2}</id><gs:cell row="{1}" col="{2}" inputValue="{3}"/></entry>';return d.prototype={fetch:function(){var b=this,c=a.Deferred();if(b._fetchReq)return b._fetchReq;var d=c.promise();return b._fetchReq=d,a.ajax({url:this.listFeed}).done(function(a,e,f){b.parse.apply(b,[a,e,f]),c.resolveWith(d,[b])}).fail(function(a,e,f){c.rejectWith(d,[f,b])}).always(function(){delete b._fetchReq}),d},parse:function(b){var c=this,d=a(b).children("feed").children("entry");if(c.rows=[],0===d.length)return c.logger.warn("Missing data for "+c.title+", make sure you didn't forget column headers"),void 0;var f;d.each(function(b){f={rowNumber:b+1},a(this).children().each(function(){e.test(this.tagName)&&(f[this.tagName.replace(e,"")]=this.textContent)}),c.rows.push(f)}),c.logger.debug('Total rows in worksheet "'+this.title+'" = '+c.rows.length)},addRows:function(b){var c,d,e,h,i=this,j=[],k=a.Deferred(),l={};return k.promise(l),a.each(b,function(b,f){c=b+1,a.each(f,function(a,b){d=a+1,null!==b&&"undefined"!=typeof b&&(e="string"==typeof b?b.encodeXML():b,j.push(g.format(i.cellsFeed,c,d,e)))})}),h=f.format(i.cellsFeed,j.join("")),a.ajax({url:this.cellsFeed+"/batch",type:"POST",contentType:"application/atom+xml",headers:{"GData-Version":"3.0","If-Match":"*"},data:h}).done(function(a,b,c){k.resolveWith(l,[a,b,c])}).fail(function(a,b,c){k.rejectWith(l,[c,i])}),l},rename:function(b){function d(a,b,c){f.rejectWith(g,[c,e])}var e=this,f=a.Deferred(),g={};return f.promise(g),e.logger.debug("Getting spreadsheet metadata before renaming worksheet"),a.ajax({url:c.PRIVATE_SHEET_URL.format(this.spreadsheet.id)}).then(function(b){e.logger.debug("Merging spreadsheet metadata before renaming worksheet");var d=a(b).children("feed");d.children("entry").filter(function(){var b=a(this).children("id").text().match(c.WORKSHEET_ID_REGEX)[0];return b===e.id}).each(function(){var a=e.spreadsheet.parseWorksheet(this);e.metadata=a.metadata})},d).then(function(){e.logger.debug("Renaming worksheet with title =",b);var c=e.metadata.clone();c.children("title").text(b);var d=(new XMLSerializer).serializeToString(c[0]);return a.ajax({url:e.editLink,type:"PUT",contentType:"application/atom+xml",data:d})}).then(function(b){var c=e.spreadsheet.parseWorksheet(a(b).children("entry"));e.metadata=c.metadata,e.title=c.title,e.listFeed=c.listFeed,e.cellsFeed=c.cellsFeed,e.editLink=c.editLink,e.logger.debug("Worksheet renamed successfully with title =",e.title),f.resolveWith(g,[e])},d),g}},d}),define("js/spreadsheet",["jquery","logger","js/utils","js/worksheet"],function(a,b,c,d){var e='<entry xmlns="http://www.w3.org/2005/Atom" xmlns:gs="http://schemas.google.com/spreadsheets/2006"><title>{0}</title><gs:rowCount>{1}</gs:rowCount><gs:colCount>{2}</gs:colCount></entry>',f=function(d){this.logger=b.get("Spreadsheet"),d=c.sanitizeOptions(d,"id"),d&&/id=/.test(d.id)&&(this.logger.info("You passed a id as a URL! Attempting to parse."),d.id=d.id.match("id=([^&]*)")[1]),a.extend(this,{id:"",title:""},d,{sheetsToLoad:[],worksheets:[]})};return f.prototype={fetch:function(b){function d(a,c,d){f.rejectWith(b.context,[d||a,e])}var e=this,f=a.Deferred(),g={};return b=a.extend({context:g},b),f.promise(g),a.ajax({url:c.PRIVATE_SHEET_URL.format(this.id)}).then(function(c,g,h){e.parse(c,g,h);var i=e.fetchSheets();i.length>0?a.when.apply(a,i).then(function(){f.resolveWith(b.context,[e])},d):f.resolveWith(b.context,[e])},d),g},isWanted:function(a){return"*"===this.wanted||this.wanted instanceof Array&&-1!==this.wanted.indexOf(a)},parse:function(b){var c=this,d=a(b).children("feed");c.title=d.children("title").text();var e;c.worksheets=[],d.children("entry").each(function(){e=c.parseWorksheet(this),c.worksheets.push(e),c.isWanted(e.title)&&c.sheetsToLoad.push(e)})},parseWorksheet:function(b){var e=a(b),f=e.children("title").text(),g=e.children("updated").text();g=g.replace(/-/g,"/").replace(/[TZ]/g," ").trim(),g=g.substr(0,g.length-4);var h=new d({id:e.children("id").text().match(c.WORKSHEET_ID_REGEX)[0],title:f,listFeed:e.children('link[rel*="#listfeed"]').attr("href"),cellsFeed:e.children('link[rel*="#cellsfeed"]').attr("href"),editLink:e.children('link[rel="edit"]').attr("href"),updatedOn:new Date(g).valueOf(),metadata:e,spreadsheet:this});return h},fetchSheets:function(){var b=[];return a.each(this.sheetsToLoad,function(a,c){b.push(c.fetch())}),b},createWorksheet:function(b){function d(a,c,d){g.rejectWith(b.context,[d||a,f])}var f=this,g=a.Deferred(),h={};return g.promise(h),b=a.extend({title:"",rows:20,cols:20,context:h,headers:[],rowData:[]},c.sanitizeOptions(b,"title")),f.logger.debug("Creating worksheet for spreadsheet",this,"with options =",b),a.ajax({url:c.PRIVATE_SHEET_URL.format(this.id),type:"POST",contentType:"application/atom+xml",headers:{"GData-Version":"3.0"},data:e.format(b.title,b.rows,b.cols)}).then(function(b,c,d){var e=a(d.responseText).filter(function(){return"ENTRY"===this.nodeName}),g=f.parseWorksheet(e);return f.worksheets.push(g),g.listFeed=g.cellsFeed.replace("/cells/","/list/"),g}).then(function(a){if(b.headers.length>0||b.rowData.length>0){var c=b.rowData;c.unshift(b.headers),a.addRows(c).then(function(){return f.logger.debug("Rows added to worksheet.",a,"Fetching latest data for worksheet"),a.fetch()}).then(function(){g.resolveWith(b.context,[a])},d)}else g.resolveWith(b.context,[a])},d),h},getWorksheet:function(b){var c;return a.each(this.worksheets,function(a,d){return d.title===b?(c=d,!1):void 0}),c}},f}),define("js/plugins/gsloader-auth",["jquery","logger","google-api-client"],function(a,b,c){function d(a,c){this.authTryCount=0,this.logger=b.get("GDAuth"),this.clientId=a,this.scopes=c}return d.prototype={checkAuth:function(b,d){this.authTryCount++;var e=d||new a.Deferred;return c.auth.authorize({client_id:this.clientId,scope:this.scopes,immediate:!1!==b},a.proxy(this,"handleAuthResult",e)),e.promise()},handleAuthResult:function(a,b){b&&!b.error?(this.logger.debug("Google Api Authentication Succeed"),this.authTryCount=0,a.resolve()):this.authTryCount<2?(this.logger.debug("Retrying to authenticating Google Api"),this.checkAuth(!1,a)):(this.authTryCount=0,a.reject())}},d}),define("js/plugins/gsloader-drive",["jquery","google-api-client","js/plugins/gsloader-auth"],function(a,b,c){var d=function(d){var e="https://www.googleapis.com/auth/drive https://spreadsheets.google.com/feeds",f=new c(d,e);b.client.load("drive","v2",a.proxy(f,"checkAuth"))};return d.prototype={createSpreadsheet:function(c){var d={},e=a.extend({title:"",context:d},c),f=a.Deferred(),g=b.client.request({path:"/drive/v2/files",method:"POST",body:{title:e.title,mimeType:"application/vnd.google-apps.spreadsheet"}});return f.promise(d),g.execute(function(a,b){a===!1?f.rejectWith(e.context,[b]):f.resolveWith(e.context,[a])}),d}},d}),define("gsloader",["jquery","logger","js/utils","js/spreadsheet","js/plugins/gsloader-drive"],function(a,b,c,d,e){String.prototype.format||(String.prototype.format=function(){for(var a=this.toString(),b=0;b<arguments.length;b++){var c=new RegExp("\\{"+b+"\\}","gm");a=a.replace(c,arguments[b])}return a}),String.prototype.encodeXML||(String.prototype.encodeXML=function(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/\n/g,"&#10;")});var f=function(){this.logger=b.get("gsloader"),this.googleDrive=null};return f.prototype={setClientId:function(a){return this.googleDrive=new e(a),this},loadSpreadsheet:function(a){a=c.sanitizeOptions(a,"id");var b=new d(a);return b.fetch({context:a.context})},createSpreadsheet:function(b){b=a.extend({title:""},c.sanitizeOptions(b,"title"));var e=this.googleDrive.createSpreadsheet({title:b.title,context:b.context}).then(function(a){var c=new d({id:a.id,title:a.title});return c.fetch({context:b.context||e})});return e}},new f});