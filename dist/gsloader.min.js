/*! Gsloader - v0.0.1 - 2012-10-17
* https://github.com/vkadam/gsloader
* Copyright (c) 2012 Vishal Kadam; Licensed MIT */
(function(e,t){"use strict";String.prototype.format||(String.prototype.format=function(){var e=this.toString();for(var t=0;t<arguments.length;t++){var n=new RegExp("\\{"+t+"\\}","gm");e=e.replace(n,arguments[t])}return e}),String.prototype.encodeXML||(String.prototype.encodeXML=function(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/\n/g,"&#10;")});var n=function(e){t.extend(this,{debug:!1},e)};n.prototype={log:function(){this.debug&&typeof console!="undefined"&&typeof console.log!="undefined"&&console.log.apply(console,arguments)}};var r=function(e){n.call(this,e)};r.prototype=new n;var i=new r;r.prototype.loadSpreadsheet=function(e){return(new s(e)).fetch()},r.prototype.enableLog=function(){return this.debug=!0,this},r.prototype.disableLog=function(){return this.debug=!1,this},r.prototype.createSpreadsheet=function(e,t,n){var r=this,i=this.drive.createSpreadsheet(e,function(e){t.apply(n||r,[(new s(e.id)).fetch()])},this);return this};var s=function(e){typeof e=="string"&&(e={id:e}),/id=/.test(e.id)&&(i.log("You passed a id as a URL! Attempting to parse."),e.id=e.id.match("id=([^&]*)")[1]),t.extend(this,{id:"",title:"",worksheets:[],wanted:[],successCallbacks:[],sheetsToLoad:0},e),this.success&&this.done(this.success)};s.PRIVATE_SHEET_URL="https://spreadsheets.google.com/feeds/worksheets/{0}/private/full",s.WORKSHEET_ID_REGEX=/.{3}$/,s.WORKSHEET_CREATE_REQ='<entry xmlns="http://www.w3.org/2005/Atom" xmlns:gs="http://schemas.google.com/spreadsheets/2006"><title>{0}</title><gs:rowCount>{1}</gs:rowCount><gs:colCount>{2}</gs:colCount></entry>',s.prototype={fetch:function(){var e=this;return t.ajax({url:s.PRIVATE_SHEET_URL.format(this.id)}).done(function(t,n,r){e.parse.apply(e,arguments)}),this},done:function(e){return this.successCallbacks.push(e),this},processSuccess:function(){var e=this;e.sheetsToLoad--,e.sheetsToLoad===0&&t.each(e.successCallbacks,function(t,n){n.apply(e)})},isWanted:function(e){return this.wanted.length===0||this.wanted.indexOf(e)!==-1},parse:function(e,n,r){var i=this,s=t(e).children("feed");i.title=s.children("title").text();var o,u;i.worksheets=[],s.children("entry").each(function(e,t){o=i.parseWorksheet(this),i.isWanted(o.title)&&i.worksheets.push(o)}),i.sheetsToLoad=i.worksheets.length,i.fetchSheets()},parseWorksheet:function(e){var n=t(e),r=n.children("title").text(),i=new o({id:n.children("id").text().match(s.WORKSHEET_ID_REGEX)[0],title:r,listFeed:n.children("link[rel*='#listfeed']").attr("href"),cellsFeed:n.children("link[rel*='#cellsfeed']").attr("href"),spreadsheet:this});return i},fetchSheets:function(){var e=this;t.each(this.worksheets,function(t,n){n.done(e.processSuccess).fetch()})},createWorksheet:function(e,n,r){var o=this;typeof e=="string"&&(e={title:e}),e=t.extend({title:"",rows:20,cols:20,callback:n||t.noop,callbackContext:r||o,headers:[],rowData:[]},e),i.log("Creating worksheet for spreadsheet",this,"with options =",e);var u;return t.ajax({url:s.PRIVATE_SHEET_URL.format(this.id),type:"POST",contentType:"application/atom+xml",headers:{"GData-Version":"3.0"},data:s.WORKSHEET_CREATE_REQ.format(e.title,e.rows,e.cols)}).done(function(n,r,s){var a=t(s.responseText).filter(function(){return this.nodeName==="ENTRY"});u=o.parseWorksheet(a),u.listFeed=u.cellsFeed.replace("/cells/","/list/"),o.worksheets.push(u);if(e.headers.length>0||e.rowData.length>0){var f=e.rowData;f.unshift(e.headers),u.addRows(f,function(){i.log("Rows added to worksheet.",u,"Fetching latest data for worksheet"),u.done(function(){e.callback.apply(e.callbackContext,[u])}).fetch()})}else e.callback.apply(e.callbackContext,[u])}),u}};var o=function(e){t.extend(this,{id:"",title:"",listFeed:"",cellsFeed:"",rows:[],spreadsheet:null,successCallbacks:[]},e)};o.COLUMN_NAME_REGEX=/gsx:/,o.CELL_FEED_HEADER='<feed xmlns="http://www.w3.org/2005/Atom" xmlns:batch="http://schemas.google.com/gdata/batch" xmlns:gs="http://schemas.google.com/spreadsheets/2006"><id>{0}</id>{1}</feed>',o.CELL_FEED_ENTRY='<entry><batch:id>R{1}C{2}</batch:id><batch:operation type="update"/><id>{0}/R{1}C{2}</id><gs:cell row="{1}" col="{2}" inputValue="{3}"/></entry>',o.prototype={fetch:function(){var e=this;return t.ajax({url:this.listFeed}).done(function(t,n,r){e.parse.apply(e,arguments),e.processSuccess.apply(e,[])}),this},done:function(e){return this.successCallbacks.push(e),this},processSuccess:function(){var e=this;t.each(e.successCallbacks,function(t,n){n.apply(e.spreadsheet,[e])})},parse:function(e,n,r){var s=this,u=t(e).children("feed").children("entry");if(u.length===0){i.log("Missing data for "+s.title+", make sure you didn't forget column headers"),s.rows=[];return}s.rows=[];var a;u.each(function(e,n){a={rowNumber:e+1},t(this).children().each(function(e,t){o.COLUMN_NAME_REGEX.test(this.tagName)&&(a[this.tagName.replace(o.COLUMN_NAME_REGEX,"")]=this.textContent)}),s.rows.push(a)}),i.log("Total rows in worksheet '"+this.title+"' = "+s.rows.length)},addRows:function(e,n){var r=this,i=[],s,u,a;t.each(e,function(e,n){s=e+1,t.each(n,function(e,t){u=e+1,t!==null&&typeof t!="undefined"&&(a=typeof t=="string"?t.encodeXML():t,i.push(o.CELL_FEED_ENTRY.format(r.cellsFeed,s,u,a)))})});var f=o.CELL_FEED_HEADER.format(r.cellsFeed,i.join(""));return t.ajax({url:this.cellsFeed+"/batch",type:"POST",contentType:"application/atom+xml",headers:{"GData-Version":"3.0","If-Match":"*"},data:f}).done(function(e,t,r){n.apply(this,arguments)}),this}},t.extend(e,{GSLoader:i})})(window,jQuery),function(e,t){"use strict";var n=function(){};n.prototype={load:function(){return gapi.client.load("drive","v2",this.onLoad),this},onLoad:function(){return e.auth.checkAuth(),this},createSpreadsheet:function(e){var n={},r=t.extend({title:"",context:n},e),i=t.Deferred(),s=gapi.client.request({path:"/drive/v2/files",method:"POST",body:{title:r.title,mimeType:"application/vnd.google-apps.spreadsheet"}});return i.promise(n),s.execute(function(e){i.resolveWith(r.context,[e])}),n},getFiles:function(e){var t=function(n,r){n.execute(function(i){r=r.concat(i.items);var s=i.nextPageToken;if(!s)return e&&e.apply(e,r),r;n=gapi.client.drive.files.list({pageToken:s}),t(n,r)})},n=gapi.client.drive.files.list();return t(n,[]),this}},t.extend(e,{drive:new n})}(GSLoader,jQuery),function(e,t){"use strict";var n=function(){this.CLIENT_ID=null,this.SCOPES=["https://www.googleapis.com/auth/drive","https://spreadsheets.google.com/feeds"].join(" ")};n.prototype={setClientId:function(e){return this.CLIENT_ID=e,this},onLoad:function(e,t){return this.checkAuth(),e&&e.apply(t,this),this},checkAuth:function(){return gapi.auth.authorize({client_id:this.CLIENT_ID,scope:this.SCOPES,immediate:!0},this.handleAuthResult),this},handleAuthResult:function(t){var r=this;return r instanceof n||(r=e.auth),t&&!t.error?e.log("Google Api Authentication Succeed"):(e.log("Authenticating Google Api"),gapi.auth.authorize({client_id:r.CLIENT_ID,scope:r.SCOPES,immediate:!1},r.handleAuthResult)),r}},t.extend(e,{auth:new n})}(GSLoader,jQuery);