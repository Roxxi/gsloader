/* Gsloader - v0.0.3rc - 2013-07-08
* https://github.com/vkadam/gsloader
* Copyright (c) 2013 Vishal Kadam; Licensed MIT */
define("js/utils",[],function(){return{sanitizeOptions:function(e,t){var r;return"string"==typeof e&&(r={},r[t]=e),r||e},PRIVATE_SHEET_URL:"https://spreadsheets.google.com/feeds/worksheets/{0}/private/full",WORKSHEET_ID_REGEX:/.{3}$/}}),define("js/worksheet",["jquery","js-logger","js/utils"],function(e,t,r){var n=function(r){this.logger=t.get("Worksheet"),e.extend(this,{id:"",title:"",listFeed:"",cellsFeed:"",editLink:"",metadata:null,rows:[],spreadsheet:null},r)},i=/gsx:/,o='<feed xmlns="http://www.w3.org/2005/Atom" xmlns:batch="http://schemas.google.com/gdata/batch" xmlns:gs="http://schemas.google.com/spreadsheets/2006"><id>{0}</id>{1}</feed>',s='<entry><batch:id>R{1}C{2}</batch:id><batch:operation type="update"/><id>{0}/R{1}C{2}</id><gs:cell row="{1}" col="{2}" inputValue="{3}"/></entry>';return n.prototype={fetch:function(){var t=this,r=e.Deferred(),n={};return r.promise(n),e.ajax({url:this.listFeed}).done(function(e,i,o){t.parse.apply(t,[e,i,o]),r.resolveWith(n,[t])}).fail(function(e,i,o){r.rejectWith(n,[o,t])}),n},parse:function(t){var r=this,n=e(t).children("feed").children("entry");if(r.rows=[],0===n.length)return r.logger.warn("Missing data for "+r.title+", make sure you didn't forget column headers"),void 0;var o;n.each(function(t){o={rowNumber:t+1},e(this).children().each(function(){i.test(this.tagName)&&(o[this.tagName.replace(i,"")]=this.textContent)}),r.rows.push(o)}),r.logger.debug("Total rows in worksheet '"+this.title+"' = "+r.rows.length)},addRows:function(t){var r,n,i,a,h=this,l=[],c=e.Deferred(),d={};return c.promise(d),e.each(t,function(t,o){r=t+1,e.each(o,function(e,t){n=e+1,null!==t&&t!==void 0&&(i="string"==typeof t?t.encodeXML():t,l.push(s.format(h.cellsFeed,r,n,i)))})}),a=o.format(h.cellsFeed,l.join("")),e.ajax({url:this.cellsFeed+"/batch",type:"POST",contentType:"application/atom+xml",headers:{"GData-Version":"3.0","If-Match":"*"},data:a}).done(function(e,t,r){c.resolveWith(d,[e,t,r])}).fail(function(e,t,r){c.rejectWith(d,[r,h])}),d},rename:function(t){function n(e,t,r){o.rejectWith(s,[r,i])}var i=this,o=e.Deferred(),s={};return o.promise(s),i.logger.debug("Getting spreadsheet metadata before renaming worksheet"),e.ajax({url:r.PRIVATE_SHEET_URL.format(this.spreadsheet.id)}).then(function(t){i.logger.debug("Merging spreadsheet metadata before renaming worksheet");var n=e(t).children("feed");n.children("entry").filter(function(){var t=e(this).children("id").text().match(r.WORKSHEET_ID_REGEX)[0];return t===i.id}).each(function(){var e=i.spreadsheet.parseWorksheet(this);i.metadata=e.metadata})},n).then(function(){i.logger.debug("Renaming worksheet with title =",t);var r=i.metadata.clone();r.children("title").text(t);var n=(new XMLSerializer).serializeToString(r[0]);return e.ajax({url:i.editLink,type:"PUT",contentType:"application/atom+xml",data:n})}).then(function(t){var r=i.spreadsheet.parseWorksheet(e(t).children("entry"));i.metadata=r.metadata,i.title=r.title,i.listFeed=r.listFeed,i.cellsFeed=r.cellsFeed,i.editLink=r.editLink,i.logger.debug("Worksheet renamed successfully with title =",i.title),o.resolveWith(s,[i])},n),s}},n}),define("js/spreadsheet",["jquery","js-logger","js/utils","js/worksheet"],function(e,t,r,n){var i='<entry xmlns="http://www.w3.org/2005/Atom" xmlns:gs="http://schemas.google.com/spreadsheets/2006"><title>{0}</title><gs:rowCount>{1}</gs:rowCount><gs:colCount>{2}</gs:colCount></entry>',o=function(n){this.logger=t.get("Spreadsheet"),n=r.sanitizeOptions(n,"id"),n&&/id=/.test(n.id)&&(this.logger.info("You passed a id as a URL! Attempting to parse."),n.id=n.id.match("id=([^&]*)")[1]),e.extend(this,{id:"",title:""},n,{sheetsToLoad:[],worksheets:[]})};return o.prototype={fetch:function(t){function n(e,r,n){o.rejectWith(t.context,[n||e,i])}var i=this,o=e.Deferred(),s={};return t=e.extend({context:s},t),o.promise(s),e.ajax({url:r.PRIVATE_SHEET_URL.format(this.id)}).then(function(r,s,a){i.parse(r,s,a);var h=i.fetchSheets();h.length>0?e.when.apply(e,h).then(function(){o.resolveWith(t.context,[i])},n):o.resolveWith(t.context,[i])},n),s},isWanted:function(e){return"*"===this.wanted||this.wanted instanceof Array&&-1!==this.wanted.indexOf(e)},parse:function(t){var r=this,n=e(t).children("feed");r.title=n.children("title").text();var i;r.worksheets=[],n.children("entry").each(function(){i=r.parseWorksheet(this),r.worksheets.push(i),r.isWanted(i.title)&&r.sheetsToLoad.push(i)})},parseWorksheet:function(t){var i=e(t),o=i.children("title").text(),s=new n({id:i.children("id").text().match(r.WORKSHEET_ID_REGEX)[0],title:o,listFeed:i.children("link[rel*='#listfeed']").attr("href"),cellsFeed:i.children("link[rel*='#cellsfeed']").attr("href"),editLink:i.children("link[rel='edit']").attr("href"),metadata:i,spreadsheet:this});return s},fetchSheets:function(){var t=[];return e.each(this.sheetsToLoad,function(e,r){t.push(r.fetch())}),t},createWorksheet:function(t){function n(e,r,n){s.rejectWith(t.context,[n||e,o])}var o=this,s=e.Deferred(),a={};return s.promise(a),t=e.extend({title:"",rows:20,cols:20,context:a,headers:[],rowData:[]},r.sanitizeOptions(t,"title")),o.logger.debug("Creating worksheet for spreadsheet",this,"with options =",t),e.ajax({url:r.PRIVATE_SHEET_URL.format(this.id),type:"POST",contentType:"application/atom+xml",headers:{"GData-Version":"3.0"},data:i.format(t.title,t.rows,t.cols)}).then(function(t,r,n){var i=e(n.responseText).filter(function(){return"ENTRY"===this.nodeName}),s=o.parseWorksheet(i);return o.worksheets.push(s),s.listFeed=s.cellsFeed.replace("/cells/","/list/"),s}).then(function(e){if(t.headers.length>0||t.rowData.length>0){var r=t.rowData;r.unshift(t.headers),e.addRows(r).then(function(){return o.logger.debug("Rows added to worksheet.",e,"Fetching latest data for worksheet"),e.fetch()}).then(function(){s.resolveWith(t.context,[e])},n)}else s.resolveWith(t.context,[e])},n),a},getWorksheet:function(t){var r;return e.each(this.worksheets,function(e,n){return n.title===t?(r=n,!1):void 0}),r}},o}),define("js/plugins/gsloader-auth",["jquery","js-logger","google-api-client"],function(e,t,r){var n=function(){t.useDefaults(t.DEBUG),this.logger=t.get("gsAuth"),this.CLIENT_ID=null,this.SCOPES=["https://www.googleapis.com/auth/drive","https://spreadsheets.google.com/feeds"].join(" ")};return n.prototype={setClientId:function(e){return this.CLIENT_ID=e,this},onLoad:function(e,t){return e&&e.apply(t,this),this},checkAuth:function(){return r.auth.authorize({client_id:this.CLIENT_ID,scope:this.SCOPES,immediate:!0},e.proxy(this,"handleAuthResult")),this},handleAuthResult:function(e){return e&&!e.error?this.logger.debug("Google Api Authentication Succeed"):(this.logger.debug("Retrying to authenticating Google Api"),this.checkAuth()),this}},new n}),define("js/plugins/gsloader-drive",["jquery","google-api-client","js/plugins/gsloader-auth"],function(e,t,r){var n=function(){};return n.prototype={load:function(){return t.client.load("drive","v2",this.onLoad),this},onLoad:function(){return r.checkAuth(),this},createSpreadsheet:function(r){var n={},i=e.extend({title:"",context:n},r),o=e.Deferred(),s=t.client.request({path:"/drive/v2/files",method:"POST",body:{title:i.title,mimeType:"application/vnd.google-apps.spreadsheet"}});return o.promise(n),s.execute(function(e,t){e===!1?o.rejectWith(i.context,[t]):o.resolveWith(i.context,[e])}),n}},new n}),define("gsloader",["jquery","js-logger","js/utils","js/spreadsheet","js/plugins/gsloader-drive"],function(e,t,r,n,i){String.prototype.format||(String.prototype.format=function(){for(var e=""+this,t=0;arguments.length>t;t++){var r=RegExp("\\{"+t+"\\}","gm");e=e.replace(r,arguments[t])}return e}),String.prototype.encodeXML||(String.prototype.encodeXML=function(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/\n/g,"&#10;")});var o=function(){t.useDefaults(t.DEBUG),this.logger=t.get("gsloader")};return o.prototype={loadSpreadsheet:function(e){e=r.sanitizeOptions(e,"id");var t=new n(e);return t.fetch({context:e.context})},createSpreadsheet:function(t){t=e.extend({title:""},r.sanitizeOptions(t,"title"));var o=i.createSpreadsheet({title:t.title,context:t.context}).then(function(e){var r=new n({id:e.id,title:e.title});return r.fetch({context:t.context||o})});return o}},new o});