/* Gsloader - v0.0.2rc - 2013-05-30
* https://github.com/vkadam/gsloader
* Copyright (c) 2013 Vishal Kadam; Licensed MIT */
(function(e,t){"use strict";String.prototype.format||(String.prototype.format=function(){for(var e=""+this,t=0;arguments.length>t;t++){var r=RegExp("\\{"+t+"\\}","gm");e=e.replace(r,arguments[t])}return e}),String.prototype.encodeXML||(String.prototype.encodeXML=function(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/\n/g,"&#10;")});var r=function(){Logger.useDefaults(Logger.DEBUG),this.logger=Logger.get("gsloader")};r.prototype={sanitizeOptions:function(e,t){var r;return"string"==typeof e&&(r={},r[t]=e),r||e},loadSpreadsheet:function(e){var r={},i=t.Deferred();e=t.extend({context:r},this.sanitizeOptions(e,"id"));var n=new Spreadsheet({id:e.id,wanted:e.wanted});return i.promise(r),n.fetch().done(function(){i.resolveWith(e.context,[n])}),r},createSpreadsheet:function(e){function r(e){var t=new Spreadsheet({id:e.id,title:e.title});t.fetch().done(function(){o.resolveWith(n.context,[t])})}var i={},n=t.extend({title:"",context:i},this.sanitizeOptions(e,"title")),o=t.Deferred();return this.drive.createSpreadsheet({title:n.title}).done(r),o.promise(i),i}};var i=new r;t.extend(e,{GSLoader:i})})(window,jQuery),function(e,t){"use strict";var r=function(e){e=GSLoader.sanitizeOptions(e,"id"),e&&/id=/.test(e.id)&&(GSLoader.logger.info("You passed a id as a URL! Attempting to parse."),e.id=e.id.match("id=([^&]*)")[1]),t.extend(this,{id:"",title:""},e,{sheetsToLoad:[],worksheets:[]})};r.PRIVATE_SHEET_URL="https://spreadsheets.google.com/feeds/worksheets/{0}/private/full",r.WORKSHEET_ID_REGEX=/.{3}$/,r.WORKSHEET_CREATE_REQ='<entry xmlns="http://www.w3.org/2005/Atom" xmlns:gs="http://schemas.google.com/spreadsheets/2006"><title>{0}</title><gs:rowCount>{1}</gs:rowCount><gs:colCount>{2}</gs:colCount></entry>',r.prototype={fetch:function(){function e(e,t,r){n.rejectWith(o,[r||e,i])}var i=this,n=t.Deferred(),o={};return n.promise(o),t.ajax({url:r.PRIVATE_SHEET_URL.format(this.id)}).then(function(r,a,s){i.parse(r,a,s);var h=i.fetchSheets();h.length>0?t.when.apply(t,h).then(function(){n.resolveWith(o,[i])},e):n.resolveWith(o,[i])},e),o},isWanted:function(e){return"*"===this.wanted||this.wanted instanceof Array&&-1!==this.wanted.indexOf(e)},parse:function(e){var r=this,i=t(e).children("feed");r.title=i.children("title").text();var n;r.worksheets=[],i.children("entry").each(function(){n=r.parseWorksheet(this),r.worksheets.push(n),r.isWanted(n.title)&&r.sheetsToLoad.push(n)})},parseWorksheet:function(e){var i=t(e),n=i.children("title").text(),o=new Worksheet({id:i.children("id").text().match(r.WORKSHEET_ID_REGEX)[0],title:n,listFeed:i.children("link[rel*='#listfeed']").attr("href"),cellsFeed:i.children("link[rel*='#cellsfeed']").attr("href"),editLink:i.children("link[rel='edit']").attr("href"),metadata:i,spreadsheet:this});return o},fetchSheets:function(){var e=[];return t.each(this.sheetsToLoad,function(t,r){e.push(r.fetch())}),e},createWorksheet:function(e){function i(t,r,i){o.rejectWith(e.context,[i||t,n])}var n=this,o=t.Deferred(),a={};return o.promise(a),e=t.extend({title:"",rows:20,cols:20,context:a,headers:[],rowData:[]},GSLoader.sanitizeOptions(e,"title")),GSLoader.logger.debug("Creating worksheet for spreadsheet",this,"with options =",e),t.ajax({url:r.PRIVATE_SHEET_URL.format(this.id),type:"POST",contentType:"application/atom+xml",headers:{"GData-Version":"3.0"},data:r.WORKSHEET_CREATE_REQ.format(e.title,e.rows,e.cols)}).then(function(e,r,i){var o=t(i.responseText).filter(function(){return"ENTRY"===this.nodeName}),a=n.parseWorksheet(o);return n.worksheets.push(a),a.listFeed=a.cellsFeed.replace("/cells/","/list/"),a}).then(function(t){if(e.headers.length>0||e.rowData.length>0){var r=e.rowData;r.unshift(e.headers),t.addRows(r).then(function(){return GSLoader.logger.debug("Rows added to worksheet.",t,"Fetching latest data for worksheet"),t.fetch()}).then(function(){o.resolveWith(e.context,[t])},i)}else o.resolveWith(e.context,[t])},i),a},getWorksheet:function(e){var r;return t.each(this.worksheets,function(t,i){return i.title===e?(r=i,!1):void 0}),r}},t.extend(e,{Spreadsheet:r})}(window,jQuery),function(e,t){"use strict";var r=function(e){t.extend(this,{id:"",title:"",listFeed:"",cellsFeed:"",editLink:"",metadata:null,rows:[],spreadsheet:null},e)};r.COLUMN_NAME_REGEX=/gsx:/,r.CELL_FEED_HEADER='<feed xmlns="http://www.w3.org/2005/Atom" xmlns:batch="http://schemas.google.com/gdata/batch" xmlns:gs="http://schemas.google.com/spreadsheets/2006"><id>{0}</id>{1}</feed>',r.CELL_FEED_ENTRY='<entry><batch:id>R{1}C{2}</batch:id><batch:operation type="update"/><id>{0}/R{1}C{2}</id><gs:cell row="{1}" col="{2}" inputValue="{3}"/></entry>',r.prototype={fetch:function(){var e=this,r=t.Deferred(),i={};return r.promise(i),t.ajax({url:this.listFeed}).done(function(t,n,o){e.parse.apply(e,[t,n,o]),r.resolveWith(i,[e])}).fail(function(t,n,o){r.rejectWith(i,[o,e])}),i},parse:function(e){var i=this,n=t(e).children("feed").children("entry");if(i.rows=[],0===n.length)return GSLoader.logger.warn("Missing data for "+i.title+", make sure you didn't forget column headers"),void 0;var o;n.each(function(e){o={rowNumber:e+1},t(this).children().each(function(){r.COLUMN_NAME_REGEX.test(this.tagName)&&(o[this.tagName.replace(r.COLUMN_NAME_REGEX,"")]=this.textContent)}),i.rows.push(o)}),GSLoader.logger.debug("Total rows in worksheet '"+this.title+"' = "+i.rows.length)},addRows:function(e){var i,n,o,a,s=this,h=[],d=t.Deferred(),c={};return d.promise(c),t.each(e,function(e,a){i=e+1,t.each(a,function(e,t){n=e+1,null!==t&&t!==void 0&&(o="string"==typeof t?t.encodeXML():t,h.push(r.CELL_FEED_ENTRY.format(s.cellsFeed,i,n,o)))})}),a=r.CELL_FEED_HEADER.format(s.cellsFeed,h.join("")),t.ajax({url:this.cellsFeed+"/batch",type:"POST",contentType:"application/atom+xml",headers:{"GData-Version":"3.0","If-Match":"*"},data:a}).done(function(e,t,r){d.resolveWith(c,[e,t,r])}).fail(function(e,t,r){d.rejectWith(c,[r,s])}),c},rename:function(e){function r(e,t,r){n.rejectWith(o,[r,i])}var i=this,n=t.Deferred(),o={};return n.promise(o),GSLoader.logger.debug("Getting spreadsheet metadata before renaming worksheet"),t.ajax({url:Spreadsheet.PRIVATE_SHEET_URL.format(this.spreadsheet.id)}).then(function(e){GSLoader.logger.debug("Merging spreadsheet metadata before renaming worksheet");var r=t(e).children("feed");r.children("entry").filter(function(){var e=t(this).children("id").text().match(Spreadsheet.WORKSHEET_ID_REGEX)[0];return e===i.id}).each(function(){var e=i.spreadsheet.parseWorksheet(this);i.metadata=e.metadata})},r).then(function(){GSLoader.logger.debug("Renaming worksheet with title =",e);var r=i.metadata.clone();r.children("title").text(e);var n=(new XMLSerializer).serializeToString(r[0]);return t.ajax({url:i.editLink,type:"PUT",contentType:"application/atom+xml",data:n})}).then(function(e){var r=i.spreadsheet.parseWorksheet(t(e).children("entry"));i.metadata=r.metadata,i.title=r.title,i.listFeed=r.listFeed,i.cellsFeed=r.cellsFeed,i.editLink=r.editLink,GSLoader.logger.debug("Worksheet renamed successfully with title =",i.title),n.resolveWith(o,[i])},r),o}},t.extend(e,{Worksheet:r})}(window,jQuery),function(e,t){"use strict";var r=function(){};r.prototype={load:function(){return gapi.client.load("drive","v2",this.onLoad),this},onLoad:function(){return e.auth.checkAuth(),this},createSpreadsheet:function(e){var r={},i=t.extend({title:"",context:r},e),n=t.Deferred(),o=gapi.client.request({path:"/drive/v2/files",method:"POST",body:{title:i.title,mimeType:"application/vnd.google-apps.spreadsheet"}});return n.promise(r),o.execute(function(e,t){e===!1?n.rejectWith(i.context,[t]):n.resolveWith(i.context,[e])}),r}},t.extend(e,{drive:new r})}(GSLoader,jQuery),function(e,t){"use strict";var r=function(){Logger.useDefaults(Logger.DEBUG),this.logger=Logger.get("gsAuth"),this.CLIENT_ID=null,this.SCOPES=["https://www.googleapis.com/auth/drive","https://spreadsheets.google.com/feeds"].join(" ")};r.prototype={setClientId:function(e){return this.CLIENT_ID=e,this},onLoad:function(e,t){return this.checkAuth(),e&&e.apply(t,this),this},checkAuth:function(){return gapi.auth.authorize({client_id:this.CLIENT_ID,scope:this.SCOPES,immediate:!0},this.handleAuthResult),this},handleAuthResult:function(t){var i=this;return i instanceof r||(i=e.auth),t&&!t.error?i.logger.debug("Google Api Authentication Succeed"):(i.logger.debug("Authenticating Google Api"),gapi.auth.authorize({client_id:i.CLIENT_ID,scope:i.SCOPES,immediate:!1},i.handleAuthResult)),i}},t.extend(e,{auth:new r})}(GSLoader,jQuery);